<!DOCTYPE html>
<html lang="en">
	<head>
    	<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link href="css/bootstrap.css" rel="stylesheet">
    	<link href="css/bootstrap-responsive.css" rel="stylesheet">
		<link href="css/ci-status.css" rel="stylesheet">

		<script type="text/javascript" src="js/jquery-2.0.2.min.js"></script>
		<script type="text/javascript" src="js/bootstrap.js"></script>
		
		<script>
			$(document).ready(function() {readStatuses(init)})
			var jobs = []

			function init(res) {
				initJobs(res);
				setInterval(function() {readStatuses(update)}, 5000)
			}

			function initJobs(res) {
				jobs = []
				var statuses = parseStatuses(res);
		        for (var build in statuses) {
		          var status = statuses[build];
		          var div = "<div class='span6 status-cell'><h2 class='" + status + "' style='height: 100%' id='" + build + "'>" + build + "</h2></div>";
		          $("#row").append(div);
		          jobs.push(build)
		    	}		    	
		    }

		    function parseStatuses(res) {
		    	return eval('(' + res.responseText + ')');
		    }

		    function update(res) {		    			    	
		    	var statuses = parseStatuses(res);
		    	if (sameJobs(statuses)) {
		    		console.log("Updating status to: " + JSON.stringify(statuses))
			        for (var build in statuses) {
			          var status = statuses[build];
			          $(jq(build)).attr("class", status);
			    	} 
		    	} else {
		    		console.log("Jobs list changed")
		    		$("#row").html("");
		    		initJobs(res)
		    	}			    	
		    }

		    function sameJobs(statuses) {
		    	var new_jobs = []
		    	for (j in statuses) {
		    		new_jobs.push(j);
		    	}
		    	// console.log("Comparing " + jobs + " to " + new_jobs);
		    	return JSON.stringify(jobs) == JSON.stringify(new_jobs);
		    }

		    function readStatuses(f) {
				$.get("statuses.json").always(f)
		    }

		    function jq( myid ) {
    			return "#" + myid.replace( /(:|\.|\[|\])/g, "\\$1" ); 
			}
		</script>
	</head>
	<body>		
		<div class="container container-fill">
			<div class="row row-fill" id="row">
				
			</div>
			
		</div>
	</body>
</html>